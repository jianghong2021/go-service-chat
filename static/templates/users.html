<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>用户管理</title>
    <link rel="stylesheet" href="/static/cdn/element-ui/2.15.1/theme-chalk/index.min.css">
    <script src="/static/cdn/vue/2.6.11/vue.min.js"></script>
    <script src="/static/cdn/element-ui/2.15.1/index.js"></script>
    <script src="/static/cdn/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .signin {
            width: 350px;
            padding: 20px;
            background: #fff;
            -webkit-box-shadow: 0 1px 2px 0 rgba(101, 129, 156, .08);
            box-shadow: 0 1px 2px 0 rgba(101, 129, 156, .08);
            border-radius: 4px;
        }

        .signin h1,
        .signin h2,
        .signin .copyright {
            font-weight: normal;
            color: #4d627b;
            text-align: center;
        }

        .signin .loginTitle {
            font-size: 22px;
            margin: 20px 0px;
        }

        .signin .copyright {
            font-size: 12px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .signin {
                width: 90%;
                box-shadow: none;
            }
        }

        .popup {
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .popup .form {
            background-color: #fff;
            padding: 20px;
            width: 350px;
        }

        .not-allow {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .not-allow p {
            font-size: 26px;
            color: #e11717;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="app">
        <template>
            <div v-if="role==0" class="not-allow">
                <p>
                    没有权限访问
                </p>
            </div>
            <template v-else>
                <el-row>
                    <el-col :span="24">
                        <div class="grid-content bg-purple-dark">
                            <el-button type="success" size="small" @click="addUser">
                                添加客服
                            </el-button>
                        </div>
                    </el-col>
                </el-row>
                <el-row :span="24">
                    <el-table :data="users">
                        <el-table-column prop="name" label="用户名" width="150">
                        </el-table-column>
                        <el-table-column prop="nickname" label="昵称" width="150">
                        </el-table-column>
                        <el-table-column prop="role" label="角色">
                            <template slot-scope="{row}">
                                <{row.role==0?'客服':'管理员'}>
                            </template>
                        </el-table-column>
                        <el-table-column fixed="right" label="操作" width="200">
                            <template slot-scope="{row}">
                                <el-button type="primary" icon="el-icon-edit" circle @click="editUser(row)"></el-button>
                                <el-button v-if="row.role =='0'" type="danger" icon="el-icon-delete" circle
                                    @click="deleteUser(row)"></el-button>

                            </template>
                        </el-table-column>
                    </el-table>
                </el-row>
                <div class="popup" v-show="popup" @click.self="popup=false">
                    <el-form class="form" :model="form" :rules="rules">
                        <el-form-item prop="username">
                            <el-input v-model.trim="form.username" placeholder="登录用户名"></el-input>
                        </el-form-item>
                        <el-form-item prop="nickname">
                            <el-input v-model.trim="form.nickname" placeholder="昵称"></el-input>
                        </el-form-item>
                        <el-form-item prop="password">
                            <el-input show-password v-model.trim="form.password" placeholder="密码"></el-input>
                        </el-form-item>
                        <!-- <el-form-item prop="role">
                            <el-radio-group v-model="form.role">
                                <el-radio label="0">客服</el-radio>
                                <el-radio label="1">管理员</el-radio>
                            </el-radio-group>
                        </el-form-item> -->
                        <el-form-item prop="rePassword">
                            <el-input show-password v-model.trim="form.rePassword" placeholder="确认密码"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button v-if="form.id>0" style="width: 100%" type="primary" @click="editUserHanlder()">
                                更新账号
                            </el-button>
                            <el-button v-else style="width: 100%" type="primary" @click="addUserHanlder()">
                                创建账号
                            </el-button>
                        </el-form-item>
                    </el-form>
                </div>
            </template>
        </template>
    </div>
    <script>
        new Vue({
            el: '#app',
            delimiters: ["<{", "}>"],
            data: {
                popup: false,
                role: 0,
                users: [],
                form: {
                    id: 0,
                    username: "",
                    password: "",
                    rePassword: "",
                    nickname: "",
                    role: '0',
                    avator: ''
                },
                rules: {
                    username: [
                        { required: true, message: 'Username is required', trigger: 'blur' },
                        { min: 2, max: 20, message: 'Username must be 2-20 characters', trigger: 'blur' }
                    ],
                    nickname: [
                        { required: true, message: 'DisplayName is required', trigger: 'blur' },
                        { min: 1, max: 60, message: 'DisplayName must be 1-60 characters', trigger: 'blur' }
                    ],
                    password: [
                        { required: true, message: 'Password is required', trigger: 'blur' },
                        { min: 2, message: 'Password must be at least 2 characters', trigger: 'blur' }
                    ],
                    rePassword: [
                        { required: true, message: 'Please confirm your password', trigger: 'blur' },
                        { validator: this.validatePasswordMatch, trigger: 'blur' }
                    ]
                },
            },
            methods: {
                loadUsers() {
                    const self = this;
                    $.get({
                        url: '/u/users',
                        headers: {
                            "token": localStorage.getItem("token")
                        },
                        success(response) {
                            if (response.code === 200) {

                                self.users = response.result;
                            } else {
                                self.$message({
                                    message: response.msg || 'Invalid credentials',
                                    type: 'error'
                                });
                            }
                        },
                        error(err) {
                            self.$message({
                                message: err.message || 'Unknown error',
                                type: 'error'
                            });
                        }
                    });
                },
                validatePasswordMatch(rule, value, callback) {
                    if (value !== this.form.password) {
                        callback(new Error('Passwords don\'t match'));
                    } else {
                        callback();
                    }
                },
                addUserHanlder() {
                    if (!this.form.username || !this.form.nickname || !this.form.password) {
                        this.$message({
                            message: '用户名,昵称,密码都是必填',
                            type: 'error'
                        });
                        return;
                    }
                    if (this.form.password !== this.form.rePassword) {
                        this.$message({
                            message: 'Passwords don\'t match',
                            type: 'error'
                        });
                        return;
                    }

                    const self = this;
                    $.post({
                        url: '/u/add',
                        headers: {
                            "token": localStorage.getItem("token")
                        },
                        data: this.form,
                        success(response) {
                            if (response.code === 200) {
                                self.$message({
                                    message: 'Account created successfully!',
                                    type: 'success'
                                });
                                self.popup = false;
                                self.loadUsers();
                            } else {
                                self.$message({
                                    message: response.msg || 'Registration failed',
                                    type: 'error'
                                });
                            }
                        },
                        error(err) {
                            self.$message({
                                message: err.message || 'Unknown error',
                                type: 'error'
                            });
                        }
                    });
                },
                addUser() {
                    this.form.id = 0;
                    this.form.username = '';
                    this.form.nickname = '';
                    this.form.role = '0';
                    this.form.avator = '';
                    this.popup = true;
                },
                editUserHanlder() {
                    if (!this.form.username || !this.form.nickname) {
                        this.$message({
                            message: '用户名,昵称都是必填',
                            type: 'error'
                        });
                        console.log(this.form)
                        return;
                    }
                    if (this.form.password !== this.form.rePassword) {
                        this.$message({
                            message: 'Passwords don\'t match',
                            type: 'error'
                        });
                        return;
                    }

                    const self = this;
                    $.post({
                        url: '/u/edit',
                        headers: {
                            "token": localStorage.getItem("token")
                        },
                        data: this.form,
                        success(response) {
                            if (response.code === 200) {
                                self.$message({
                                    message: 'Account created successfully!',
                                    type: 'success'
                                });
                                self.popup = false;
                                self.loadUsers();
                            } else {
                                self.$message({
                                    message: response.msg || 'Registration failed',
                                    type: 'error'
                                });
                            }
                        },
                        error(err) {
                            self.$message({
                                message: err.message || 'Unknown error',
                                type: 'error'
                            });
                        }
                    });
                },
                editUser(user) {
                    this.form.id = user.id;
                    this.form.username = user.name;
                    this.form.nickname = user.nickname;
                    this.form.role = user.role;
                    this.form.avator = user.avator;
                    this.popup = true;
                },
                deleteUserHandler(user) {
                    const self = this;
                    $.post({
                        url: '/u/delete?id='+user.id,
                        headers: {
                            "token": localStorage.getItem("token")
                        },
                        data: this.form,
                        success(response) {
                            if (response.code === 200) {
                                self.$message({
                                    message: '删除成功!',
                                    type: 'success'
                                });
                                self.popup = false;
                                self.loadUsers();
                            } else {
                                self.$message({
                                    message: response.msg || 'Registration failed',
                                    type: 'error'
                                });
                            }
                        },
                        error(err) {
                            self.$message({
                                message: err.message || 'Unknown error',
                                type: 'error'
                            });
                        }
                    });
                },
                deleteUser(user) {
                    this.$confirm('即将删除此账号, 是否继续?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        this.deleteUserHandler(user);
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '已取消删除'
                        });
                    });
                }
            },
            created() {
                this.role = sessionStorage.getItem('usre-role') || 0;
                if (this.role > 0) {
                    this.loadUsers();
                }
            },
        })
    </script>
</body>

</html>