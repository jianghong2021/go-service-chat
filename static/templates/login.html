<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>C8客服系统</title>
    <link rel="shortcut icon" href="/static/images/1.png" type="image/x-icon">
    <link rel="stylesheet" href="/static/cdn/element-ui/2.15.1/theme-chalk/index.min.css">
    <script src="/static/cdn/vue/2.6.11/vue.min.js"></script>
    <script src="/static/cdn/element-ui/2.15.1/index.js"></script>
    <script src="/static/cdn/jquery/3.6.0/jquery.min.js"></script>

    <style>
        body {
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .signin {
            width: 350px;
            padding: 20px;
            background: #fff;
            -webkit-box-shadow: 0 1px 2px 0 rgba(101, 129, 156, .08);
            box-shadow: 0 1px 2px 0 rgba(101, 129, 156, .08);
            border-radius: 4px;
        }

        .signin h1,
        .signin h2,
        .signin .copyright {
            font-weight: normal;
            color: #4d627b;
            text-align: center;
        }

        .signin .loginTitle {
            font-size: 22px;
            margin: 20px 0px;
        }

        .signin .copyright {
            font-size: 12px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .signin {
                width: 90%;
                box-shadow: none;
            }
        }
    </style>
</head>

<body>
    <div id="app" class="signin">
        <template>
            <div class="loginHtml">
                <h1 class="loginTitle">C8客服系统</h1>
                <el-form :model="form" :rules="rules" ref="loginForm" v-show="!showRegHtml">
                    <el-form-item prop="账号">
                        <el-input v-model="form.account" placeholder="请输入账号"></el-input>
                    </el-form-item>
                    <el-form-item prop="密码">
                        <el-input show-password v-on:keyup.enter.native="handleLoginWithV3" v-model="form.password"
                            placeholder="请输入密码"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button :disabled="loginLoading" style="width: 100%" type="primary"
                            @click="handleLoginWithV3">登录</el-button>
                    </el-form-item>
                </el-form>
            </div>
        </template>
    </div>
</body>
<script>
    const GOOGLE_CAPTCHA_KEY = '6Leptz0sAAAAAIweL_Q--LlA0joYY6S6D78ccI45';
    new Vue({
        el: '#app',
        delimiters: ["<{", "}>"],
        data: {
            loginLoading: false,
            GOOGLE_CAPTCHA_KEY,
            form: {
                token: '',
                account: "",
                password: "",
                rePassword: "",
                nickname: "",
            },
            rules: {
                account: [
                    { required: true, message: 'Username is required', trigger: 'blur' },
                    { min: 2, max: 20, message: 'Username must be 2-20 characters', trigger: 'blur' }
                ],
                nickname: [
                    { required: true, message: 'DisplayName is required', trigger: 'blur' },
                    { min: 1, max: 60, message: 'DisplayName must be 1-60 characters', trigger: 'blur' }
                ],
                password: [
                    { required: true, message: 'Password is required', trigger: 'blur' },
                    { min: 2, message: 'Password must be at least 2 characters', trigger: 'blur' }
                ],
                rePassword: [
                    { required: true, message: 'Please confirm your password', trigger: 'blur' },
                    { validator: this.validatePasswordMatch, trigger: 'blur' }
                ]
            },
            showRegHtml: false,
        },
        methods: {
            handleLogin(token) {
                this.$refs.loginForm.validate((valid) => {
                    if (valid) {
                        this.login(token);
                    } else {
                        this.loginLoading = false;
                    }
                });
            },

            login(token) {
                const data = {
                    "username": this.form.account,
                    "password": this.form.password,
                    "token": token,
                };

                $.post("/check", data, (response) => {
                    if (response.code === 200) {
                        this.$message({
                            message: 'Welcome back!',
                            type: 'success'
                        });
                        localStorage.setItem("token", response.result.token);
                        window.location.href = "/main";
                    } else {
                        this.$message({
                            message: response.message || 'Invalid credentials',
                            type: 'error'
                        });
                    }
                    this.loginLoading = false;
                }).fail(() => {
                    this.$message({
                        message: 'Connection error',
                        type: 'error'
                    });
                    this.loginLoading = false;
                })
            },
            initCaptcha() {
                this.loginLoading = true;
                const script = document.createElement('script');
                script.src = 'https://www.google.com/recaptcha/api.js?render=' + GOOGLE_CAPTCHA_KEY;
                script.onload = ()=>{
                    this.loginLoading = false;
                }
                document.head.appendChild(script);
            },
            handleLoginWithV3(e) {
                e.preventDefault();
                this.loginLoading = true
                grecaptcha.ready(() => {
                    grecaptcha.execute(GOOGLE_CAPTCHA_KEY, { action: 'login' })
                        .then(token => {
                            this.handleLogin(token);
                        }).catch(err => {
                            console.error(err)
                            this.$message({
                                message: err.message || 'google验证失败',
                                type: 'error'
                            });
                            this.loginLoading = false;
                        })
                });
            },
        },
        created: function () {
            this.initCaptcha();
            if (top.location != location) {
                top.location.href = location.href;
            }
        }
    });
</script>

</html>